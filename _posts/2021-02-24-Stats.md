---
layout: post
published: On
title: Node Exporter | Container stats collector 구현
category: nodeexporter
subtitle: Container별 memory, cpu, network 하드웨어 리소스 구하기
date: '2021-02-24'
---

# Development of NodeExporter <br> that collect hardware resource by container

Node Exporter는 다양한 하드웨어 상태와 커널관련 메트릭을 수집하는 모니터링 도구이다. <br>
전체적인 구조와 분석은 여기[]에서 확인할 수 있다. <br>

해당 게시물에서는 prometheus 오픈소스 node exporter에 추가적인 코드를 작성하여  <br>
container별 하드웨어 리소스를 얻기위한 collector를 등록하고, 원하는 메트릭 정보를 수집하는 데 사용된 주요 함수와 개념들을 정리하였다. 
<br>

## Metrics 

CPU, Memory, Network

```sh
# CPU
cat /proc/$PID/stat
fields Info
pid, comm, state, ppid, pgrp, seeeion, tty_nr, tpgid, flags, minflt, cminflt, majflt, cmajflt, utime, stime, cutime, cstime, proitiry, nice, num_threads, iteralvalue, starttime, vsize, rss, rsslim, startcode, endcode, ....
```

utime(14) + cutime(16) = user <br>
stime(15) + cstime(17) = sys <br>

CPU 사용량 계산 방법 : (cur(value) - prev(value))/(cur(time) - prev(time)) = usage persent(%) <br>
따라서 14, 15, 16, 17 컬럼 데이터 파싱하여 전달

```sh
# Memory
cat /proc/$PID/status
vmSize  : [ top VIRT ]  
VmRSS   : [ top RES  ]
RssFile : [ top SHR  ]
```

```sh
# Network
cat /proc/$PID/net/dev
Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
  eth0:  487276    3778    0    0    0     0          0         0   390223    3727    0    0    0     0       0          0
    lo:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
```
rxBytes, rxPackets, txBytes, txPackets 파싱하여 전달


<br>

## 1. docker api로 container 정보 받기

현재 실행되고있는 컨테이너의 정보를 가져오기 위해서는 docker api를 활용할 수 있다. <br>
container type은 id, name, command, state 등의 값을 갖는다.<br>
참고 : <https://github.com/moby/moby/blob/master/api/types/types.go>



```go
func main() {
  ctx := context.Backgroud()
  cli, _ := client.NewClientWithOps(client.FromEnv, client.WithAPIVersionNegotiaion())
  containers, err := cli.ContainerList(ctx, types.ContainerListOptions{})
}

```


## 2. golang으로 cmd process를 생성하여 각 컨테이너별 pid 알아내기
단 이때 실제 pid가 아닌 경우도 있으니 golang의 directory exits 통해 확인하기
<br>
실제 cmd 에시

```sh
[root@k8s-dev /]# cd /run/docker/runtime-runc/moby/${container-id}
[root@k8s-dev ${container-id}]# ls
state.json
[root@k8s-dev ${container-id}]# cat state.json | grep pids
"pids":"/sys/fs/cgroup/pids/system.slice/docker-${container-id}.scope"}
[root@k8s-dev ${container-id}]# cd /sys/fs/cgroup/pids/system.slice/docker-${container-id}.scope
[root@k8s-dev ${container-id}]# cat tasks
pids 목록 출력
```

컨테이너별 pid 파싱

```go
for _, container := range containers {
		m := make(map[string]interface{})

		pidpath := exec.Command("bash", "-c", "cd /run/docker/runtime-runc/moby/"+container.ID+" && cat state.json")
		outputPath, _ := pidpath.Output()

		//parse state.json of each container
		err := json.Unmarshal(outputPath, &m)
		if err != nil {
			panic(err)
		}

		jsondata, _ := json.Marshal(m["cgroup_paths"].(map[string]interface{})["pids"])

		//Get PIDs of each container
		pid, _ := (exec.Command("bash", "-c", "cd "+string(jsondata)+" && cat tasks")).Output()

		slice := strings.Split(string(pid), "\n") //컨테이너별 pid 목록을 slice에 하나씩 저장
}
```



<br><br>

## 전체 코드
<https://github.com/hyobins/node-exporter-with-container>




# 정리할 것 
## node exporter
- node exporter 내 코드 정리하고, 주석 깔끔하게 달기
- node exporter 코드 분석 collector 등록 -> update -> 채널 쓰기등 활용 위주로 정리하기 
- 함수 명 정리
  
## 개념 
리눅스 공부 계획 세우기 
vi 에디터 사용법 그때그때 정리 (일단 기본적인것 정리)
문자열 파싱 함수 사용해본 것 정리  
자료구조(배열, 맵, 슬라이스), 구조체 개념 정리

## 회고
전체적인 회고
