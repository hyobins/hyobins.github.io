---
layout: post
published: On
title: Container별 Stats 정보 구하기
category: nodeexporter
subtitle: Container별 memory, cpu, network 하드웨어 리소스 구하기
date: '2021-02-24'
---

## 1. docker api로 container id 받기

주요 함수, 알고리즘<br>

현재 실행되고있는 컨테이너의 정보를 가져오기 위해서는 docker api를 활용할 수 있다. <br>
container type은 id, name, command, state 등의 값을 갖는다.<br>
 (참고: https://github.com/moby/moby/blob/master/api/types/types.go)


```go
func main() {
  ctx := context.Backgroud()
  cli, _ := client.NewClientWithOps(client.FromEnv, client.WithAPIVersionNegotiaion())
  containers, err := cli.ContainerList(ctx, types.ContainerListOptions{})
  
  // "."으로 접근가능
  containerID := container.ID
  containerName := container.Names
}

```


## 2. golang으로 cmd process를 생성하여 각 컨테이너별 pid 알아내기

<br>
실제 cmd 에시

```sh
[root@k8s-dev /]# cd run/docker/runtime-runc/moby/${container-id}
[root@k8s-dev ${container-id}]# ls
state.json
[root@k8s-dev ${container-id}]# cat state.json | grep pids
"pids":"/sys/fs/cgroup/pids/system.slice/docker-${container-id}.scope"}
```

단 이때 실제 pid가 아닌 경우도 있으니 golang의 directory exits 통해 확인하기

<br><br>

## 3. bytes, packets 를 파싱해서 전달  

```sh
cat /proc/$PID/net/dev
Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
  eth0:  487276    3778    0    0    0     0          0         0   390223    3727    0    0    0     0       0          0
    lo:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
```



# 정리할 것 
## node exporter
- node exporter 내 코드 정리하고, 주석 깔끔하게 달기
- node exporter 코드 분석 collector 등록 -> update -> 채널 쓰기등 활용 위주로 정리하기 
- 함수 명 정리
  
## 개념 
리눅스 공부 계획 세우기 
vi 에디터 사용법 그때그때 정리 (일단 기본적인것 정리)
문자열 파싱 함수 사용해본 것 정리  
자료구조(배열, 맵, 슬라이스), 구조체 개념 정리

## 회고
전체적인 회고
